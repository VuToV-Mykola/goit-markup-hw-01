name: –°–∏—Å—Ç–µ–º–∞ –ª–∞–π–∫—ñ–≤ —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: '–î–æ–¥–∞—Ç–∏ –ª–∞–π–∫ (1 –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)'
        required: false
        default: true
        type: boolean

env:
  BADGE_STYLE: for-the-badge
  BADGE_COLOR: brightgreen
  LIKES_COLOR: red

jobs:
  update-stats:
    runs-on: ubuntu-latest

    steps:
      - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
        uses: actions/checkout@v4

      - name: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö
        run: |
          if [ ! -f "likes-data.json" ]; then
            echo '{"total_likes":0,"unique_users":[]}' > likes-data.json
          fi
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1}' > visitor-data.json
          fi

      - name: –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤
        run: |
          if ${{ github.event.inputs.add_like }}; then
            USER="${{ github.actor }}"
            if ! jq -e --arg u "$USER" '.unique_users | contains([$u])' likes-data.json; then
              jq --arg u "$USER" '.total_likes += 1 | .unique_users += [$u]' likes-data.json > tmp.json && mv tmp.json likes-data.json
            fi
          fi
          jq -n --arg l "$(jq -r '.total_likes // 0' likes-data.json)" \
            --arg v "$(jq -r '.unique_visitors // 1' visitor-data.json)" \
            '{likes: $l, views: $v}' > stats.json

      - name: –û–Ω–æ–≤–ª–µ–Ω–Ω—è README
        run: |
          REPO="https://github.com/${{ github.repository }}"
          WORKFLOW_URL="$REPO/actions/workflows/${{ github.workflow }}.yml"
          LIKES=$(jq -r '.likes' stats.json)
          VIEWS=$(jq -r '.views' stats.json)

          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![–õ–∞–π–∫–∏](https://img.shields.io/endpoint?url=$REPO/stats.json&label=‚ù§Ô∏è%20–ª–∞–π–∫–∏&color=red&style=flat-square)]($WORKFLOW_URL)"
            echo "[![–ü–µ—Ä–µ–≥–ª—è–¥–∏](https://img.shields.io/endpoint?url=$REPO/stats.json&label=üëÄ%20–ø–µ—Ä–µ–≥–ª—è–¥–∏&color=green&style=flat-square)]($WORKFLOW_URL)"
            echo ""
            echo "## –Ø–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫:"
            echo "1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –±–µ–π–¥–∂ —ñ–∑ —Å–µ—Ä–¥–µ—á–∫–æ–º –≤–∏—â–µ"
            echo "2. –û–±–µ—Ä—ñ—Ç—å \"Run workflow\""
            echo "3. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –¥—ñ—é"
            echo ""
            echo "## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
            echo "- –í—Å—å–æ–≥–æ –ª–∞–π–∫—ñ–≤: $LIKES"
            echo "- –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤: $VIEWS"
            echo ""
            echo "## –ë–µ–π–¥–∂—ñ"
            echo "[![–õ–∞–π–∫–∏]($REPO/stats.json?label=–ª–∞–π–∫–∏&color=red)]($WORKFLOW_URL)"
            echo "[![–ü–µ—Ä–µ–≥–ª—è–¥–∏]($REPO/stats.json?label=–ø–µ—Ä–µ–≥–ª—è–¥–∏&color=green)]($WORKFLOW_URL)"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md

      - name: –ó–∞–ø–∏—Å –∑–º—ñ–Ω
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" || exit 0
          git push
