name: System of likes and views

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *' # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏
  workflow_dispatch:
    inputs:
      add_like:
        description: '–î–æ–¥–∞—Ç–∏ –ª–∞–π–∫ (–ª–∏—à–µ –æ–¥–∏–Ω –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)'
        required: false
        default: true
        type: boolean
      screenshot_selector:
        description: 'CSS —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –∑–Ω—ñ–º–∫—É –µ–∫—Ä–∞–Ω—É'
        required: false
        default: 'body'
        type: string

env:
  SCREENSHOT_WIDTH: 1920
  SCREENSHOT_HEIGHT: 1080
  BADGE_STYLE: for-the-badge
  BADGE_COLOR: brightgreen
  LIKES_COLOR: red

jobs:
  update-stats:
    name: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    runs-on: ubuntu-latest

    steps:
      - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable jq

      - name: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö
        run: |
          if [ ! -f "likes-data.json" ]; then
            echo '{"total_likes":0,"unique_users":[],"created_at":"","last_updated":""}' > likes-data.json
          fi
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1,"last_updated":"","fallback_mode":true}' > visitor-data.json
          fi

      - name: –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤
        run: |
          if [ "${{ github.event.inputs.add_like }}" = "true" ]; then
            USER="${{ github.actor }}"
            CURRENT_USERS=$(jq -r '.unique_users[]' likes-data.json 2>/dev/null || echo "")
            
            if echo "$CURRENT_USERS" | grep -q "$USER"; then
              echo "‚û°Ô∏è $USER –≤–∂–µ —Å—Ç–∞–≤–∏–≤ –ª–∞–π–∫ —Ä–∞–Ω—ñ—à–µ"
            else
              jq --arg user "$USER" --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                '.total_likes += 1 | .unique_users += [$user] | .last_updated = $date | if .created_at == "" then .created_at = $date else . end' \
                likes-data.json > tmp.json && mv tmp.json likes-data.json
              echo "‚ù§Ô∏è –ù–æ–≤–∏–π –ª–∞–π–∫ –≤—ñ–¥ $USER"
            fi
          fi

          LIKES=$(jq -r '.total_likes // 0' likes-data.json)
          echo "{\"schemaVersion\":1,\"label\":\"‚ù§Ô∏è –ª–∞–π–∫–∏\",\"message\":\"$LIKES\",\"color\":\"${{ env.LIKES_COLOR }}\",\"style\":\"${{ env.BADGE_STYLE }}\"}" > likes-count.json

      - name: –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            CURRENT=$(jq -r '.unique_visitors // 1' visitor-data.json)
            NEW=$((CURRENT + 1))
            jq --arg count "$NEW" --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '.unique_visitors = ($count | tonumber) | .last_updated = $date' \
              visitor-data.json > tmp.json && mv tmp.json visitor-data.json
          fi

          VIEWS=$(jq -r '.unique_visitors // 1' visitor-data.json)
          echo "{\"schemaVersion\":1,\"label\":\"üëÄ –ø–µ—Ä–µ–≥–ª—è–¥–∏\",\"message\":\"$VIEWS\",\"color\":\"${{ env.BADGE_COLOR }}\",\"style\":\"${{ env.BADGE_STYLE }}\"}" > visitor-count.json

      - name: –û–Ω–æ–≤–ª–µ–Ω–Ω—è README
        run: |
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/workflows/${{ github.workflow }}.yml"
          LIKES=$(jq -r '.total_likes // 0' likes-data.json)
          VIEWS=$(jq -r '.unique_visitors // 1' visitor-data.json)

          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![–ü–µ—Ä–µ–≥–ª—è–¥–∏](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)](${WORKFLOW_URL})"
            echo "[![‚ù§Ô∏è –õ–∞–π–∫–∏](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)](${WORKFLOW_URL})"
            echo ""
            echo "## ‚ù§Ô∏è –Ø–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫:"
            echo "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —á–µ—Ä–≤–æ–Ω–µ —Å–µ—Ä—Ü–µ –≤–∏—â–µ ‚ù§Ô∏è –∞–±–æ –Ω–∞ –∑—ñ—Ä–æ—á–∫—É –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó"
            echo "## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
            echo "- –í—Å—å–æ–≥–æ –ª–∞–π–∫—ñ–≤: [$LIKES](${WORKFLOW_URL})"
            echo "- –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –ø–µ—Ä–µ–≥–ª—è–¥—ñ–≤: [$VIEWS](${WORKFLOW_URL})"
            echo ""
            echo "### –ë–µ–π–¥–∂—ñ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ:"
            echo "- [![–õ–∞–π–∫–∏](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)](${WORKFLOW_URL})"
            echo "- [![–ü–µ—Ä–µ–≥–ª—è–¥–∏](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)](${WORKFLOW_URL})"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md

      - name: –ó–∞–ø–∏—Å –∑–º—ñ–Ω
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "üîÑ Statistics Update: $ Views Views, $ Likes likes" || exit 0
          git push
