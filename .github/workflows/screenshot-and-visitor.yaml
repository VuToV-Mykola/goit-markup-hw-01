name: System of likes and views

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ»Ğ°Ğ¹Ğº (1 Ğ½Ğ° ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°)'
        required: false
        default: true
        type: boolean

env:
  BADGE_STYLE: for-the-badge
  BADGE_COLOR: brightgreen
  LIKES_COLOR: red

jobs:
  update-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ñ–Ñ
        uses: actions/checkout@v4

      - name: Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
        run: |
          if [ ! -f "likes-data.json" ]; then
            echo '{"total_likes":0,"unique_users":[]}' > likes-data.json
          fi
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1}' > visitor-data.json
          fi

      - name: ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ»Ğ°Ğ¹ĞºÑ–Ğ²
        run: |
          if [ "${{ github.event.inputs.add_like }}" = "true" ]; then
            USER="${{ github.actor }}"
            if ! jq -e --arg u "$USER" '.unique_users | contains([$u])' likes-data.json; then
              jq --arg u "$USER" '.total_likes += 1 | .unique_users += [$u]' likes-data.json > tmp.json && mv tmp.json likes-data.json
            fi
          fi
          jq -n --arg l "$(jq -r '.total_likes // 0' likes-data.json)" \
            --arg v "$(jq -r '.unique_visitors // 1' visitor-data.json)" \
            '{likes: $l, views: $v}' > stats.json

      - name: ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ README
        run: |
          REPO="https://github.com/${{ github.repository }}"
          WORKFLOW_URL="$REPO/actions/workflows/${{ github.workflow }}.yml"
          LIKES=$(jq -r '.likes' stats.json)
          VIEWS=$(jq -r '.views' stats.json)

          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![Ğ›Ğ°Ğ¹ĞºĞ¸](https://img.shields.io/endpoint?url=$REPO/stats.json&label=â¤ï¸%20Ğ»Ğ°Ğ¹ĞºĞ¸&color=red&style=flat-square)]($WORKFLOW_URL)"
            echo "[![ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸](https://img.shields.io/endpoint?url=$REPO/stats.json&label=ğŸ‘€%20Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸&color=green&style=flat-square)]($WORKFLOW_URL)"
            echo ""
            echo "## Ğ¯Ğº Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚Ğ¸ Ğ»Ğ°Ğ¹Ğº:"
            echo "1. ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ±ĞµĞ¹Ğ´Ğ¶ Ñ–Ğ· ÑĞµÑ€Ğ´ĞµÑ‡ĞºĞ¾Ğ¼ Ğ²Ğ¸Ñ‰Ğµ"
            echo "2. ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ \"Run workflow\""
            echo "3. ĞŸÑ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ñ–Ñ‚ÑŒ Ğ´Ñ–Ñ"
            echo ""
            echo "## Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°"
            echo "- Ğ’ÑÑŒĞ¾Ğ³Ğ¾ Ğ»Ğ°Ğ¹ĞºÑ–Ğ²: $LIKES"
            echo "- Ğ£Ğ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ñ… Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ñ–Ğ²: $VIEWS"
            echo ""
            echo "## Ğ‘ĞµĞ¹Ğ´Ğ¶Ñ–"
            echo "[![Ğ›Ğ°Ğ¹ĞºĞ¸]($REPO/stats.json?label=Ğ»Ğ°Ğ¹ĞºĞ¸&color=red)]($WORKFLOW_URL)"
            echo "[![ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸]($REPO/stats.json?label=Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸&color=green)]($WORKFLOW_URL)"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md

      - name: Ğ—Ğ°Ğ¿Ğ¸Ñ Ğ·Ğ¼Ñ–Ğ½
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ğŸ”„ Updated statistics" || exit 0
          git push