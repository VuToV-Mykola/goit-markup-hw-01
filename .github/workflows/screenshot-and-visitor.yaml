name: Ð—Ð½Ñ–Ð¼Ð¾Ðº ÐµÐºÑ€Ð°Ð½Ñƒ Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð»Ð°Ð¹ÐºÑ–Ð²/Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´Ñ–Ð²

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: 'Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð»Ð°Ð¹Ðº (Ð»Ð¸ÑˆÐµ Ð¾Ð´Ð¸Ð½ Ð½Ð° ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°)'
        required: false
        default: true
        type: boolean
      screenshot_selector:
        description: 'CSS ÑÐµÐ»ÐµÐºÑ‚Ð¾Ñ€ Ð´Ð»Ñ Ð·Ð½Ñ–Ð¼ÐºÑƒ ÐµÐºÑ€Ð°Ð½Ñƒ'
        required: false
        default: 'body'
        type: string

env:
  SCREENSHOT_WIDTH: ${{ vars.SCREENSHOT_WIDTH || '1920' }}
  SCREENSHOT_HEIGHT: ${{ vars.SCREENSHOT_HEIGHT || '1080' }}
  BADGE_STYLE: ${{ vars.BADGE_STYLE || 'for-the-badge' }}
  BADGE_COLOR: ${{ vars.BADGE_COLOR || 'brightgreen' }}
  LIKES_COLOR: ${{ vars.LIKES_COLOR || 'red' }}

jobs:
  update-readme-and-visitor:
    runs-on: ubuntu-latest

    steps:
      # ... (Ñ–Ð½ÑˆÑ– ÐºÑ€Ð¾ÐºÐ¸ Ð·Ð°Ð»Ð¸ÑˆÐ°ÑŽÑ‚ÑŒÑÑ Ð±ÐµÐ· Ð·Ð¼Ñ–Ð½)

      - name: ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð»Ñ–Ñ‡Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ° Ð²Ñ–Ð´Ð²Ñ–Ð´ÑƒÐ²Ð°Ð½ÑŒ
        run: |
          # Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ñ–Ð´Ñ€Ð°Ñ…ÑƒÐ½ÐºÑƒ Ð²Ñ–Ð´Ð²Ñ–Ð´ÑƒÐ²Ð°Ð½ÑŒ
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1,"last_updated":"","fallback_mode":true}' > visitor-data.json
          fi

          # Ð—Ð±Ñ–Ð»ÑŒÑˆÐµÐ½Ð½Ñ Ð¿Ñ€Ð¸ Ñ€ÑƒÑ‡Ð½Ð¾Ð¼Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÑƒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ÐµÐ¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            CURRENT=$(jq -r '.unique_visitors' visitor-data.json)
            NEW=$((CURRENT + 1))
            jq --arg count "$NEW" --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '.unique_visitors = ($count | tonumber) | .last_updated = $date' \
              visitor-data.json > tmp.json && mv tmp.json visitor-data.json
          fi

          CURRENT_VISITORS=$(jq -r '.unique_visitors' visitor-data.json)
          echo "{\"schemaVersion\":1,\"label\":\"ðŸ‘€ Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´Ð¸\",\"message\":\"$CURRENT_VISITORS\",\"color\":\"${{ env.BADGE_COLOR }}\",\"style\":\"${{ env.BADGE_STYLE }}\"}" > visitor-count.json

      - name: ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ README
        run: |
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          LIKES=$(jq -r '.total_likes' likes-data.json)
          VIEWS=$(jq -r '.unique_visitors' visitor-data.json)

          # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ README
          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![ÐŸÐµÑ€ÐµÐ³Ð»ÑÐ´Ð¸](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)]"
            echo "[![â¤ï¸ Ð›Ð°Ð¹ÐºÐ¸](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)]"
            echo ""
            echo "## ðŸ’– Ð¯Ðº Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚Ð¸ Ð»Ð°Ð¹Ðº:"
            echo "1. ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ Ñ‡ÐµÑ€Ð²Ð¾Ð½Ðµ ÑÐµÑ€Ñ†Ðµ Ð²Ð¸Ñ‰Ðµ - Ð²Ð°Ñˆ Ð»Ð°Ð¹Ðº Ð±ÑƒÐ´Ðµ Ð´Ð¾Ð´Ð°Ð½Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾!"
            echo ""
            echo "## ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°"
            echo "- Ð’ÑÑŒÐ¾Ð³Ð¾ Ð»Ð°Ð¹ÐºÑ–Ð²: [![Ð›Ð°Ð¹ÐºÐ¸](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)]"
            echo "- Ð£Ð½Ñ–ÐºÐ°Ð»ÑŒÐ½Ð¸Ñ… Ð¿ÐµÑ€ÐµÐ³Ð»ÑÐ´Ñ–Ð²: [![ÐŸÐµÑ€ÐµÐ³Ð»ÑÐ´Ð¸](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)]"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md
