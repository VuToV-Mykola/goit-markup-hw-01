name: System of likes and views

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: 'Додати лайк (1 на користувача)'
        required: false
        default: true
        type: boolean

env:
  BADGE_STYLE: for-the-badge
  BADGE_COLOR: brightgreen
  LIKES_COLOR: red

jobs:
  update-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Завантаження репозиторію
        uses: actions/checkout@v4

      - name: Ініціалізація даних
        run: |
          if [ ! -f "likes-data.json" ]; then
            echo '{"total_likes":0,"unique_users":[]}' > likes-data.json
          fi
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1}' > visitor-data.json
          fi

      - name: Обробка лайків
        run: |
          if [ "${{ github.event.inputs.add_like }}" = "true" ]; then
            USER="${{ github.actor }}"
            if ! jq -e --arg u "$USER" '.unique_users | contains([$u])' likes-data.json; then
              jq --arg u "$USER" '.total_likes += 1 | .unique_users += [$u]' likes-data.json > tmp.json && mv tmp.json likes-data.json
            fi
          fi
          jq -n --arg l "$(jq -r '.total_likes // 0' likes-data.json)" \
            --arg v "$(jq -r '.unique_visitors // 1' visitor-data.json)" \
            '{likes: $l, views: $v}' > stats.json

      - name: Оновлення README
        run: |
          REPO="https://github.com/${{ github.repository }}"
          WORKFLOW_URL="$REPO/actions/workflows/${{ github.workflow }}.yml"
          LIKES=$(jq -r '.likes' stats.json)
          VIEWS=$(jq -r '.views' stats.json)

          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![Лайки](https://img.shields.io/endpoint?url=$REPO/stats.json&label=❤️%20лайки&color=red&style=flat-square)]($WORKFLOW_URL)"
            echo "[![Перегляди](https://img.shields.io/endpoint?url=$REPO/stats.json&label=👀%20перегляди&color=green&style=flat-square)]($WORKFLOW_URL)"
            echo ""
            echo "## Як поставити лайк:"
            echo "1. Натисніть бейдж із сердечком вище"
            echo "2. Оберіть \"Run workflow\""
            echo "3. Підтвердіть дію"
            echo ""
            echo "## Статистика"
            echo "- Всього лайків: $LIKES"
            echo "- Унікальних переглядів: $VIEWS"
            echo ""
            echo "## Бейджі"
            echo "[![Лайки]($REPO/stats.json?label=лайки&color=red)]($WORKFLOW_URL)"
            echo "[![Перегляди]($REPO/stats.json?label=перегляди&color=green)]($WORKFLOW_URL)"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md

      - name: Запис змін
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "🔄 Updated statistics" || exit 0
          git push