name: Знімок екрану та система лайків/переглядів

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: 'Додати лайк (лише один на користувача)'
        required: false
        default: true
        type: boolean
      screenshot_selector:
        description: 'CSS селектор для знімку екрану'
        required: false
        default: 'body'
        type: string

env:
  SCREENSHOT_WIDTH: ${{ vars.SCREENSHOT_WIDTH || '1920' }}
  SCREENSHOT_HEIGHT: ${{ vars.SCREENSHOT_HEIGHT || '1080' }}
  BADGE_STYLE: ${{ vars.BADGE_STYLE || 'for-the-badge' }}
  BADGE_COLOR: ${{ vars.BADGE_COLOR || 'brightgreen' }}
  LIKES_COLOR: ${{ vars.LIKES_COLOR || 'red' }}

jobs:
  update-readme-and-visitor:
    runs-on: ubuntu-latest

    steps:
      # ... (інші кроки залишаються без змін)

      - name: Оновлення лічильника відвідувань
        run: |
          # Резервна система підрахунку відвідувань
          if [ ! -f "visitor-data.json" ]; then
            echo '{"unique_visitors":1,"last_updated":"","fallback_mode":true}' > visitor-data.json
          fi

          # Збільшення при ручному запуску користувачем
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            CURRENT=$(jq -r '.unique_visitors' visitor-data.json)
            NEW=$((CURRENT + 1))
            jq --arg count "$NEW" --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '.unique_visitors = ($count | tonumber) | .last_updated = $date' \
              visitor-data.json > tmp.json && mv tmp.json visitor-data.json
          fi

          CURRENT_VISITORS=$(jq -r '.unique_visitors' visitor-data.json)
          echo "{\"schemaVersion\":1,\"label\":\"👀 перегляди\",\"message\":\"$CURRENT_VISITORS\",\"color\":\"${{ env.BADGE_COLOR }}\",\"style\":\"${{ env.BADGE_STYLE }}\"}" > visitor-count.json

      - name: Оновлення README
        run: |
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          LIKES=$(jq -r '.total_likes' likes-data.json)
          VIEWS=$(jq -r '.unique_visitors' visitor-data.json)

          # Генерація нового README
          {
            echo "# ${{ github.event.repository.name }}"
            echo ""
            echo "[![Перегляди](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)]"
            echo "[![❤️ Лайки](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)]"
            echo ""
            echo "## 💖 Як поставити лайк:"
            echo "1. Натисніть червоне серце вище - ваш лайк буде додано автоматично!"
            echo ""
            echo "## 📊 Статистика"
            echo "- Всього лайків: [![Лайки](https://img.shields.io/endpoint?url=${REPO_URL}/likes-count.json)]"
            echo "- Унікальних переглядів: [![Перегляди](https://img.shields.io/endpoint?url=${REPO_URL}/visitor-count.json)]"
            echo ""
            
            if [ -f "README_template.md" ]; then
              cat README_template.md
            fi
          } > README.md
