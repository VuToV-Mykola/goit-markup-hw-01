name: Screenshot & Visitor Badge Update

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 * * * *' # —â–æ–≥–æ–¥–∏–Ω–∏
  workflow_dispatch:

jobs:
  update-readme-and-visitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Google Chrome
        run: sudo apt-get update && sudo apt-get install -y google-chrome-stable

      - name: Install dependencies
        run: npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true

      - name: Generate screenshot
        run: npm run screenshot

      - name: Fetch repo traffic and generate visitor badge
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "üîπ Fetching repository views..."
          VIEWS=$(curl -s -H "Authorization: token $PAT_TOKEN" \
            https://api.github.com/repos/VuToV-Mykola/goit-markup-hw-02/traffic/views \
            | jq '.count')

          if [ "$VIEWS" = "null" ] || [ -z "$VIEWS" ]; then
            VIEWS=0
          fi

          echo "üü¢ Repository Views: $VIEWS"

          echo "{\"schemaVersion\":1,\"label\":\"views\",\"message\":\"$VIEWS\",\"color\":\"brightgreen\",\"style\":\"for-the-badge\"}" > visitor-count.json

      - name: Update README.md
        run: |
          # –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª –∑ –±–µ–π–¥–∂–µ–º —ñ —Å–∫—Ä—ñ–Ω—à–æ—Ç–æ–º –Ω–∞ –ø–æ—á–∞—Ç–∫—É
          echo "![Visitor Count](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/VuToV-Mykola/goit-markup-hw-02/main/visitor-count.json)" > README_new.md
          echo "" >> README_new.md
          echo "## Screenshot" >> README_new.md
          echo "" >> README_new.md
          echo "![Screenshot](screenshot.png)" >> README_new.md
          echo "" >> README_new.md

          # –î–æ–¥–∞—î–º–æ —Ä–µ—à—Ç—É README –∑ —à–∞–±–ª–æ–Ω—É
          cat README_template.md >> README_new.md

          # –ó–∞–º—ñ–Ω—é—î–º–æ —Å—Ç–∞—Ä–∏–π README –Ω–∞ –Ω–æ–≤–∏–π
          mv README_new.md README.md

      - name: Commit & Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git pull --rebase --autostash origin main

          git add README.md screenshot.png visitor-count.json
          git commit -m "Update README, screenshot and visitor badge [ci skip]" || echo "No changes to commit"
          git push

      - name: Show screenshot info
        run: ls -lh screenshot.png
